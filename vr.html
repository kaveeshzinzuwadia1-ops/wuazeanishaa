<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Record a Voice Note</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/recordrtc@5.6.2/RecordRTC.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                "cream": "#FDFBF7",
                "dusty-rose": "#E2B4BD",
                "rose-gold": "#D4A373",
                "sage-green": "#9DB4A9",
                "charcoal": "#363636",
                "dark-rose": "#7D5A5A",
              },
              fontFamily: {
                "display": ["Newsreader", "serif"],
              },
              borderRadius: {"DEFAULT": "1.25rem", "lg": "2.25rem", "xl": "3.25rem", "full": "9999px"},
            },
          },
        }
    </script>
    <style type="text/tailwindcss">
        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(212, 163, 115, 0.25);
            box-shadow: 0 4px 24px 0 rgba(125, 90, 90, 0.08);
        }
        .bg-gradient-pastel {
            background: linear-gradient(135deg, #FDFBF7 0%, #F5E6E8 50%, #E2B4BD 100%);
        }
        .floating-dust {
            position: absolute;
            background: #E2B4BD;
            border-radius: 50%;
            opacity: 0.3;
            pointer-events: none;
        }
        .wave-bar {
            display: inline-block;
            height: 30px;
            width: 4px;
            margin: 0 2px;
            background-color: #E2B4BD;
            border-radius: 2px;
            animation: wave 0.6s ease-in-out infinite;
        }
        @keyframes wave {
            0%, 100% {
                height: 20px;
            }
            50% {
                height: 40px;
            }
        }
        .wave-bar:nth-child(2) {
            animation-delay: 0.1s;
        }
        .wave-bar:nth-child(3) {
            animation-delay: 0.2s;
        }
        .wave-bar:nth-child(4) {
            animation-delay: 0.3s;
        }
        .wave-bar:nth-child(5) {
            animation-delay: 0.4s;
        }
    </style>
    <style>
        body {
            min-height: 100dvh;
        }
    </style>
</head>
<body class="bg-cream font-display overflow-hidden selection:bg-dusty-rose/30 text-charcoal">
<div class="fixed inset-0 bg-gradient-pastel z-0">
    <div class="floating-dust w-2 h-2 top-1/4 left-1/4 blur-sm"></div>
    <div class="floating-dust w-3 h-3 top-3/4 left-1/3 blur-md opacity-20"></div>
    <div class="floating-dust w-2 h-2 top-1/2 left-2/3 blur-sm"></div>
    <div class="floating-dust w-4 h-4 top-1/3 left-3/4 blur-lg opacity-10"></div>
</div>

<div class="relative z-10 flex flex-col min-h-screen max-w-md mx-auto">
    <header class="flex items-center p-4 pb-2 justify-between">
        <div id="backBtn" aria-label="Back" class="text-dark-rose/60 flex size-12 shrink-0 items-center cursor-pointer hover:text-dark-rose transition-colors">
            <span class="material-symbols-outlined text-2xl">arrow_back_ios</span>
        </div>
        <h2 class="text-dark-rose/80 text-lg font-medium leading-tight tracking-[-0.015em] flex-1 text-center pr-12 opacity-60">Voice Note</h2>
    </header>

    <main class="flex-1 flex flex-col items-center justify-center px-6">
        <div class="glass-card rounded-xl p-10 text-center max-w-sm border-rose-gold/20">
            <h2 class="text-charcoal tracking-tight text-[26px] font-medium leading-[1.4] pb-6">
                Say what's on your heart
            </h2>
            <p class="text-dark-rose/70 text-base font-normal leading-relaxed">
                Record a message and save it to listen anytime.
            </p>

            <div id="recordingIndicator" class="mt-8 flex items-center justify-center gap-2" style="display: none;">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>

            <div id="timerDisplay" class="mt-8 text-dark-rose text-2xl font-bold" style="display: none;">00:00</div>

            <div class="mt-8 flex flex-col items-center gap-4">
                <button id="recordBtn" class="flex items-center justify-center size-16 rounded-full glass-card border border-sage-green/40 text-sage-green hover:bg-sage-green/10 active:scale-95 transition-all duration-300 shadow-sm">
                    <span class="material-symbols-outlined text-3xl" style="font-variation-settings: 'wght' 300;">mic</span>
                </button>
                <span class="text-dark-rose/40 text-[10px] uppercase tracking-widest font-semibold">Click to record</span>
            </div>

            <div id="playbackSection" style="display: none;" class="mt-8 flex flex-col gap-4">
                <div class="text-left">
                    <audio id="audioPlayback" controls class="w-full"></audio>
                </div>
                <button id="saveBtn" class="flex min-w-[100px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-8 bg-sage-green text-cream gap-2 border border-sage-green/20 hover:bg-sage-green/90 transition-colors font-bold uppercase text-xs tracking-widest">
                    <span class="material-symbols-outlined fill-[1]">check_circle</span>
                    Save Note
                </button>
                <button id="retakeBtn" class="flex min-w-[100px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-8 bg-white/40 text-dark-rose gap-2 border border-rose-gold/20 hover:bg-white/60 transition-colors font-bold uppercase text-xs tracking-widest">
                    <span class="material-symbols-outlined">refresh</span>
                    Retake
                </button>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let recordingStartTime;
    let timerInterval;

    const recordBtn = document.getElementById('recordBtn');
    const backBtn = document.getElementById('backBtn');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const timerDisplay = document.getElementById('timerDisplay');
    const playbackSection = document.getElementById('playbackSection');
    const audioPlayback = document.getElementById('audioPlayback');
    const saveBtn = document.getElementById('saveBtn');
    const retakeBtn = document.getElementById('retakeBtn');

    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimer() {
        recordingStartTime = Date.now();
        timerInterval = setInterval(function() {
            const elapsed = Date.now() - recordingStartTime;
            timerDisplay.textContent = formatTime(elapsed);
        }, 100);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    recordBtn.addEventListener('click', async function() {
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];

                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    playbackSection.style.display = 'flex';
                    recordBtn.style.display = 'none';
                    recordingIndicator.style.display = 'none';
                    timerDisplay.style.display = 'none';
                };

                mediaRecorder.start();
                isRecording = true;
                recordBtn.innerHTML = '<span class="material-symbols-outlined text-3xl">stop_circle</span>';
                recordingIndicator.style.display = 'flex';
                timerDisplay.style.display = 'block';
                startTimer();
            } catch (error) {
                alert('Unable to access microphone. Please check permissions.');
                console.error('Microphone access error:', error);
            }
        } else {
            mediaRecorder.stop();
            isRecording = false;
            recordBtn.innerHTML = '<span class="material-symbols-outlined text-3xl" style="font-variation-settings: \'wght\' 300;">mic</span>';
            stopTimer();

            // Stop all tracks
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
    });

    retakeBtn.addEventListener('click', function() {
        audioChunks = [];
        audioPlayback.src = '';
        playbackSection.style.display = 'none';
        recordBtn.style.display = 'flex';
        recordBtn.innerHTML = '<span class="material-symbols-outlined text-3xl" style="font-variation-settings: \'wght\' 300;">mic</span>';
        timerDisplay.textContent = '00:00';
    });

    saveBtn.addEventListener('click', async function() {
        if (audioChunks.length === 0) return;

        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append('audio', audioBlob, `voice_note_${Date.now()}.wav`);

        try {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="material-symbols-outlined fill-[1]">hourglass_empty</span> Saving...';

            const response = await fetch('save_voice_note.php', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert('Voice note saved successfully to voice_notes folder!');
                setTimeout(function() {
                    window.location.href = 'wehungup.html';
                }, 500);
            } else {
                alert('Error: ' + result.message);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span class="material-symbols-outlined fill-[1]">check_circle</span> Save Note';
            }
        } catch (error) {
            // Fallback to download if backend fails
            const url = URL.createObjectURL(audioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voice_note_${Date.now()}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Voice note saved to Downloads folder');
            setTimeout(function() {
                window.location.href = 'wehungup.html';
            }, 500);
        }
    });

    backBtn.addEventListener('click', function() {
        if (isRecording) {
            if (confirm('Stop recording and go back?')) {
                mediaRecorder.stop();
                isRecording = false;
                stopTimer();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                window.location.href = 'wehungup.html';
            }
        } else {
            window.location.href = 'wehungup.html';
        }
    });
});
</script>

</body>
</html>
